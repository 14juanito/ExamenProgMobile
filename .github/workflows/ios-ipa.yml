name: iOS IPA (codesign)

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: "Export method (app-store, ad-hoc, development)"
        required: false
        default: "ad-hoc"
  push:
    branches: [main]
    paths:
      - "lib/**"
      - "ios/**"
      - "pubspec.yaml"
      - "pubspec.lock"

jobs:
  build-ipa:
    runs-on: macos-latest
    env:
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
      KEYCHAIN_NAME: build.keychain-db
      KEYCHAIN_PASSWORD: temp_pass_123
      EXPORT_METHOD: ${{ github.event.inputs.export_method || 'ad-hoc' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Flutter pub get
        run: flutter pub get

      - name: Install pods
        run: |
          cd ios
          pod install --repo-update

      - name: Create signing keychain
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security list-keychains -s "$KEYCHAIN_NAME" $(security list-keychains | tr -d '"')
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

      - name: Import signing certificate
        env:
          CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          echo "$CERT_BASE64" | base64 --decode > /tmp/signing.p12
          security import /tmp/signing.p12 -k "$KEYCHAIN_NAME" -P "$CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

      - name: Install provisioning profile
        env:
          PROFILE_BASE64: ${{ secrets.APPLE_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Generate ExportOptions.plist
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.APPLE_BUNDLE_ID }}
          PROFILE_NAME: ${{ secrets.APPLE_PROFILE_NAME }}
        run: |
          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>${EXPORT_METHOD}</string>
            <key>teamID</key><string>${APPLE_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key><string>${PROFILE_NAME}</string>
            </dict>
            <key>compileBitcode</key><false/>
            <key>signingStyle</key><string>manual</string>
            <key>stripSwiftSymbols</key><true/>
          </dict>
          </plist>
          EOF

      - name: Build IPA
        env:
          BUNDLE_ID: ${{ secrets.APPLE_BUNDLE_ID }}
          CODE_SIGN_IDENTITY: ${{ secrets.APPLE_CODE_SIGN_IDENTITY }}
        run: |
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist \
            --build-name=1.0.0 --build-number=${{ github.run_number }}

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Runner-ipa
          path: build/ios/ipa/*.ipa
